module sonic-stp {
    namespace "http://github.com/sonic-net/sonic-stp";
    prefix stp;
<<<<<<< HEAD
    yang-version 1.1;

    import sonic-extension {
=======

    import sonic-ext {
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
        prefix sonic-ext;
    }

    description "SONiC STP YANG model for PVST and MST configurations";

<<<<<<< HEAD
    revision 2024-11-24 {
=======
    revision 2024-11-22 {
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
        description "Version01 for combined PVST and MST configurations.";
    }

    grouping vlanModeAttr {
        leaf forward_delay {
            type uint8 {
                range "4..30" {
                    error-message "Invalid Forwarding Delay value.";
                }
            }
            units seconds;
            default 15;
            description
                "The delay used by STP bridges to transition root and
                designated ports to forwarding";
        }

        leaf hello_time {
            type uint8 {
                range "1..10" {
                    error-message "Invalid Hello Time value.";
                }
            }
            units seconds;
            default 2;
            description
                "The interval between periodic transmissions of
                configuration messages by designated ports";
        }

        leaf max_age {
            type uint8 {
                range "6..40" {
                    error-message "Invalid Maximum Age Time value.";
                }
            }
            units seconds;
            default 20;
            description
                "The maximum age of the information transmitted by the
                bridge when it is the root bridge";
        }

        leaf priority {
            type uint16 {
                range "0..61440" {
                    error-message "Invalid Bridge Priority value.";
                }
            }
<<<<<<< HEAD
=======
            sonic-ext:custom-validation ValidateBridgePriority;
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
            default 32768;
            description
                "The manageable component of the Bridge Identifier";
        }
    }

<<<<<<< HEAD
    grouping interfaceAttr {
        leaf path_cost {
            type uint64 {
                range "1..200000000" {
                    error-message "Invalid Port Path Cost value.";
                }
            }
            default 200;
            description
                "The port's contribution, when it is the Root Port,
                to the Root Path Cost for the Bridge";
        }

        leaf priority {
            type uint8 {
                range "0..240" {
                    error-message "Invalid Port Priority value.";
                }
            }
            default 128;
            description
                "The manageable component of the Port Identifier,
                also known as the Port Priority";
        }
    }

    container sonic-spanning-tree {

        container STP {
            list STP_LIST {
                max-elements 1;
                key "keyleaf";
                leaf keyleaf {
                    type enumeration {
                        enum GLOBAL;
                    }
                    description
                        "Key node identifier. It's value is always GLOBAL";
                }

                leaf mode {
                    type enumeration {
                        enum pvst;
                        enum mst;
                    }
                    mandatory true;
                    description
                        "Spanning tree mode";
                }

                leaf rootguard_timeout {
                    must "../../../STP/STP_LIST[keyleaf='GLOBAL']/mode!='mst'" {
                        error-message "Configuration not allowed in MST mode";
                        error-app-tag stp-invalid;
                    }

                    type uint16 {
                        range "5..600" {
                            error-message "Invalid Root-guard Timeout value.";
                        }
                    }
                    units seconds;
                    description
                        "Once superior BPDUs stop coming on the port, device
                        will wait for a period until root guard timeout before
                        moving the port to forwarding state";
                }

                uses vlanModeAttr;
=======
    container stp {
        description "STP global and per-instance configurations";

        container global {
            description "Global STP settings";
            leaf mode {
                type enumeration {
                    enum "pvst" {
                        description "Per VLAN Spanning Tree mode";
                    }
                    enum "mst" {
                        description "Multiple Spanning Tree mode";
                    }
                }
                description "STP mode (PVST or MST)";
            }
            leaf rootguard_timeout {
                type uint16 {
                    range "5..600";
                }
                default "30";
                description "Root guard timeout in seconds";
            }

            uses vlanModeAttr;
            
            // MST-specific attributes
            leaf mst_name {
                when "../mode = 'mst'";
                type string {
                    length "1..32";
                }
                default "<MAC_ADDRESS>";
                description "MST region name (default: MAC address of switch)";
            }
            leaf mst_revision {
                when "../mode = 'mst'";
                type uint16 {
                    range "0..65535";
                }
                default "0";
                description "MST region revision number";
            }
            leaf mst_max_hop {
                when "../mode = 'mst'";
                type uint8 {
                    range "1..40";
                }
                default "20";
                description "Maximum hops in MST region";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
            }
        }

        container STP_VLAN {
            list STP_VLAN_LIST {
                key "name";
<<<<<<< HEAD
                leaf name {
                    type string;
                    description
                        "Vlan identifier";
=======
                sonic-ext:custom-validation ValidateStpMaxInstance;
                leaf name {
                    type string;
                    description "Vlan identifier";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                leaf vlanid {
                    type uint16 {
                        range "1..4095" {
                            error-message "Vlan ID out of range";
                            error-app-tag vlanid-invalid;
                        }
                    }
<<<<<<< HEAD
                    description
                        "Vlan identifier number";
=======
                    description "Vlan identifier number";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                leaf enabled {
                    type boolean;
<<<<<<< HEAD
                    mandatory true;
                    description
                        "Spanning tree enabled/disabled on Vlan";
=======
                    sonic-ext:custom-validation ValidateStpDisableVlan;
                    mandatory true;
                    description "Spanning tree enabled/disabled on Vlan";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                uses vlanModeAttr;
            }
        }

<<<<<<< HEAD
        container STP_VLAN_PORT {
            list STP_VLAN_PORT_LIST {
                key "vlan-name ifname";

                leaf vlan-name {
                    type leafref {
                        path "../../../STP_VLAN/STP_VLAN_LIST/name";
                    }
                    description
                        "Reference to Vlan";
                }

                leaf ifname {
                    type leafref {
                        path "../../../STP_PORT/STP_PORT_LIST/ifname";
                    }
                    description
                        "Reference to Ethernet interface or PortChannel";
                }

                uses interfaceAttr;
            }
        }

        container STP_PORT {
            list STP_PORT_LIST {
                key "ifname";
                sonic-ext:dependent-on "STP_LIST";
                leaf ifname {
                    type string;
                    description
                        "Reference to Ethernet interface or PortChannel";
                }

                leaf enabled {
                    type boolean;
                    mandatory true;
                    description
                        "Spanning tree enabled/disabled on Interface";
                }

                leaf root_guard {
                    type boolean;
                    description
                        "Enable/Disable Root guard on port";
                }

                leaf bpdu_guard {
                    type boolean;
                    description
                        "Enable/Disable port BPDU guard";
                }

                leaf bpdu_guard_do_disable {
                    type boolean;
                    description
                        "Port to be disabled when it receives a BPDU";
                }

                leaf uplink_fast {
                    type boolean;
                    description
                        "Enable/Disable uplink-fast on port";
                }

                leaf portfast {
                    must "current()!='true' or ../../../STP/STP_LIST[keyleaf='GLOBAL']/mode='pvst'" {
                        error-message "Configuration not allowed in MST mode";
                        error-app-tag stp-invalid;
                    }
                    type boolean;
                    description
                        "Enable/Disable portfast on port";
                }

                uses interfaceAttr;

                // For MST
                leaf edge_port {
                    type boolean;
                    description
                        "Enable/Disable Edge-port on interface";
                }

                leaf link_type {
                    type enumeration {
                        enum auto;
                        enum shared;
                        enum point-to-point;
                    }
                    description
                        "Specifies the interface's link type. Permissible values
                        are 'shared', 'point-to-point' and 'auto'";
                }
            }
        }

=======
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
        container STP_MST {
            list STP_MST_LIST {
                max-elements 1;
                key "keyleaf";
                sonic-ext:dependent-on "STP_LIST";

                leaf keyleaf {
                    type enumeration {
                        enum GLOBAL;
                    }
<<<<<<< HEAD
                    description
                        "Key node identifier. It's value is always GLOBAL";
=======
                    description "Key node identifier. It's value is always GLOBAL";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                leaf name {
                    must "../../../STP/STP_LIST[keyleaf='GLOBAL']/mode='mst'" {
                        error-message "Configuration allowed in MST mode";
                        error-app-tag stp-invalid;
                    }
                    type string;
<<<<<<< HEAD
                    description
                        "MST Region name";
=======
                    description "MST Region name";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                leaf revision {
                    must "../../../STP/STP_LIST[keyleaf='GLOBAL']/mode='mst'" {
                        error-message "Configuration allowed in MST mode";
                        error-app-tag stp-invalid;
                    }
                    type uint32;
<<<<<<< HEAD
                    description
                        "MST Revision number";
=======
                    description "MST Revision number";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                leaf max_hops {
                    must "../../../STP/STP_LIST[keyleaf='GLOBAL']/mode='mst'" {
                        error-message "Configuration allowed in MST mode";
                        error-app-tag stp-invalid;
                    }
                    type uint8;
<<<<<<< HEAD
                    description
                        "MST Max hops";
=======
                    description "MST Max hops";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                leaf hello_time {
                    must "../../../STP/STP_LIST[keyleaf='GLOBAL']/mode='mst'" {
                        error-message "Configuration allowed in MST mode";
                        error-app-tag stp-invalid;
                    }
                    type uint8;
<<<<<<< HEAD
                    description
                        "MST hello time";
=======
                    description "MST hello time";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                leaf max_age {
                    must "../../../STP/STP_LIST[keyleaf='GLOBAL']/mode='mst'" {
                        error-message "Configuration allowed in MST mode";
                        error-app-tag stp-invalid;
                    }
                    type uint8;
<<<<<<< HEAD
                    description
                        "MST max age";
=======
                    description "MST max age";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                leaf forward_delay {
                    must "../../../STP/STP_LIST[keyleaf='GLOBAL']/mode='mst'" {
                        error-message "Configuration allowed in MST mode";
                        error-app-tag stp-invalid;
                    }
                    type uint8;
<<<<<<< HEAD
                    description
                        "MST forward delay";
=======
                    description "MST forward delay";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }

                leaf hold_count {
                    must "../../../STP/STP_LIST[keyleaf='GLOBAL']/mode='mst'" {
                        error-message "Configuration allowed in MST mode";
                        error-app-tag stp-invalid;
                    }
                    type uint8;
<<<<<<< HEAD
                    description
                        "MST hold count";
=======
                    description "MST hold count";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }
            }
        }

<<<<<<< HEAD
        container STP_MST_INST {
            list STP_MST_INST_LIST {
                key "instance";

                leaf instance {
                    type uint16;
                    description
                        "Instance identifier";
                }

                leaf-list vlan {
                    type string;
                    description
                        "Vlan list";
                }

                leaf bridge_priority {
                    type uint16 {
                        range "0..61440" {
                            error-message "Invalid Bridge Priority value.";
                        }
                    }
                    description
                        "The manageable component of the Bridge Identifier";
=======
        container interface {
            list interface {
                key "name";
                description "Interface-level STP configuration";
                leaf name {
                    type string;
                    description "Interface name (physical or port-channel)";
                }
                leaf enabled {
                    type boolean;
                    default "true";
                    description "Whether STP is enabled on this interface";
                }
                leaf root_guard {
                    type boolean;
                    default "false";
                    description "Whether root guard is enabled on this interface";
                }
                leaf bpdu_guard {
                    type boolean;
                    default "false";
                    description "Whether BPDU guard is enabled";
                }
                leaf bpdu_guard_do_disable {
                    type boolean;
                    default "false";
                    description "Disable port when BPDU is received";
                }
                leaf path_cost {
                    type uint32 {
                        range "1..200000000";
                    }
                    description "Path cost for this interface";
                }
                leaf priority {
                    type uint8 {
                        range "0..240";
                    }
                    default "128";
                    description "Interface priority";
                }
                leaf portfast {
                    type boolean;
                    default "false";
                    description "Portfast is enabled or not";
                }
                leaf uplink_fast {
                    type boolean;
                    default "false";
                    description "Uplink fast is enabled or not";
                }
            }
        }

        container mst_instance {
            list mst_instance {
                when "../global/mode = 'mst'";
                key "instance-id";
                description "MST instance configurations";
                leaf instance-id {
                    type uint8 {
                        range "0..63";
                    }
                    description "MST instance ID";
                }
                leaf bridge_priority {
                    type uint16 {
                        range "0..61440";
                    }
                    default "32768";
                    description "Bridge priority for this MST instance";
                }
                leaf vlan_list {
                    type string;
                    description "List of VLANs assigned to this MST instance";
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
                }
            }
        }

<<<<<<< HEAD
        container STP_MST_PORT {
            list STP_MST_PORT_LIST {
                key "inst_id ifname";

                leaf inst_id {
                    type leafref {
                        path "../../../STP_MST_INST/STP_MST_INST_LIST/instance";
                    }
                    description
                        "Reference to MST Instance";
                }

                leaf ifname {
                    type leafref {
                        path "../../../STP_PORT/STP_PORT_LIST/ifname";
                    }

                    description
                        "Reference to Ethernet interface or PortChannel";
                }
                uses interfaceAttr;
=======
        container mst_port {
            list mst_port {
                when "../global/mode = 'mst'";
                key "instance-id interface";
                description "Per-port MST configuration";
                leaf instance-id {
                    type uint8 {
                        range "0..63";
                    }
                    description "MST instance ID";
                }
                leaf interface {
                    type string;
                    description "Interface name (physical or port-channel)";
                }
                leaf path_cost {
                    type uint32 {
                        range "1..20000000";
                    }
                    description "Path cost for this MST instance port";
                }
                leaf priority {
                    type uint8 {
                        range "0..240";
                    }
                    default "128";
                    description "Port priority for this MST instance";
                }
>>>>>>> ddfcc98d031b6f46853fd499afae377559c5c794
            }
        }
    }
}